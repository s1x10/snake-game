
<!DOCTYPE html>
<html style="height: 100%; margin: 0;">
    <head>
        <title>Snake Game</title>
        <style>
            canvas {
                border: 20px solid black;
            }
        </style>
    </head>
    <body style="height: 100%; margin: 0; position: relative">
    
        <div>  
            <canvas id="snakegame" width="200" height="200" style="position: relative">  </canvas>
            
            <div  id="menu" hidden style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);  flex-direction: column; gap: 20px; justify-content: center; align-items: center;" >
                <div>
                    <span>Points</span><span id="pointsG" style="margin-left: 8px;">0</span>
                    <button  id="startGameButton" onclick="restartGame();">Start game</button>
                </div>
                <div>
                    <label>apple amount:</label>
                    <select onchange="appleAmount()" id="Number of apples" name="Number of apples" value="1">
                        <option value=1>1 apple</option>
                        <option value=2>2 apples</option>
                        <option value=3>3 apples</option>
                        <option value=4>4 apples</option>
                    </select>
                </div>
                <div>
                    <label>Game size:</label>
                    <select onchange="resizeGame()" name="size" id="size" value="4">
                        <option value=2>Little</option>
                        <option value=3>Medium</option>
                        <option value=4>Big</option>
                        <option value=5>Very big</option>
                        <option value=6>Massive</option>
                    </select>
                </div>
                <div>
                    <label>Game speed:</label>
                    <select onchange="setSpeed()" name="speed" id="speed" value="5">
                        <option value="4">Slow</option>
                        <option value="5">Medium</option>
                        <option value="6">Fast</option>
                        <option value="7">Very fast</option>
                        <option value="10">Impossible</option>
                    </select>
                </div>
            </div>
            <div  id="restartGameMenu" hidden style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);  flex-direction: column; gap: 20px; justify-content: center; align-items: center;" >
                <div>
                    <span>Points</span><span id="pointsR" style="margin-left: 10px; margin-top: 20px">0</span>
                    <button  id="restartGameButton" onclick="restartGame();">Start game</button>
                    <button  id="openMenuButton" onclick="openMenu();">Menu</button>
                </div>
            </div>
            <div id="pointDisplay" style="position: absolute;">
                <span>Points</span><span id="points" style="margin-left: 8px;">0</span>
            </div>
        </div>
        
        

        
        
        <script>
            
            const canvas = document.querySelector("canvas");
            const ctx = canvas.getContext("2d")
            canvas.getBoundingClientRect()
            let pointElement = document.getElementById("points")
            let pointElementR = document.getElementById("pointsR")
            let restartGameMenu = document.getElementById("restartGameMenu")
            let menu = document.getElementById("menu")
            let restartGameButton = document.getElementById("restartGameButton")
            let startGameButton = document.getElementById("startGameButton")
            let gameSpeed = 5;
            let frameRate = 1000 / gameSpeed;
            let then = performance.now();
            let squareSize = { x: 20, y: 20 }
            let food = {x: 2, y: 4}
            let food1 = {x: 4, y: 7}
            let food2 = {x: 8, y: 4}
            let food3 = {x: 9, y: 3}
            let isFirstRun = true
            let points = 0
            let snake =
                [
                    {x: 10, y:10},
                    {x: 10, y:11},
                    {x: 10, y:12}]
            let speed = {x: 0, y: -1}
            let lastDirection = {x: 0, y: -1};
            let move = 
                [
                ]
            let isAlive = false
            
            
            function canvasCenter(){
                const rect = canvas.getBoundingClientRect()
                canvas.style.position = 'absolute'
                let x = (window.innerWidth - rect.width) / 2 
                let y = (window.innerHeight - rect.height) / 2 
                canvas.style.left = `${x}px`
                canvas.style.top = `${y}px`
            }
            window.onload = () => {
                canvasCenter()
            }
            window.addEventListener('resize', canvasCenter)
            
            resizeGame()
            let size = parseInt(document.getElementById("size").value)
            let ButtonWidth = (squareSize.x * 2) * size
            let ButtonHeight = (squareSize.y * 1) * size
            let menuButtonX = (canvas.width - ButtonWidth) / 2
            let menuButtonY = (canvas.height - ButtonHeight) / 2 + ButtonHeight
            openMenu()



            function openMenu(){
                restartGameMenu.hidden = true
                menu.hidden = false
            }
            function openRestartGameMenu(){
                restartGameMenu.hidden = false
            }
            function keydown() {
                document.addEventListener('keydown', (event) => {


                    if (event.key === "ArrowRight" && lastDirection.x !== -1) {
                        if (!move.includes(0)) {
                            move.push(0)
                        }
                    } else if (event.key === "ArrowLeft" && lastDirection.x !== 1) {
                        if (!move.includes(1)) {
                            move.push(1)
                        }
                    } else if (event.key === "ArrowUp" && lastDirection.y !== 1) {
                        if (!move.includes(2)) {
                            move.push(2)
                        }
                    } else if (event.key === "ArrowDown" && lastDirection.y !== -1) {
                        if (!move.includes(3)) {
                            move.push(3)
                        }
                    }

                    if (event.key === "d" && lastDirection.x !== -1) {
                        if (!move.includes(0)) {
                            move.push(0)
                        }
                    } else if (event.key === "a" && lastDirection.x !== 1) {
                        if (!move.includes(1)) {
                            move.push(1)
                        }
                    } else if (event.key === "w" && lastDirection.y !== 1) {
                        if (!move.includes(2)) {
                            move.push(2)
                        }
                    } else if (event.key === "s" && lastDirection.y !== -1) {
                        if (!move.includes(3)) {
                            move.push(3)
                        }
                    }
                    
                    if (event.key === "D" && lastDirection.x !== -1) {
                        if (!move.includes(0)) {
                            move.push(0)
                        }
                    } else if (event.key === "A" && lastDirection.x !== 1) {
                        if (!move.includes(1)) {
                            move.push(1)
                        }
                    } else if (event.key === "W" && lastDirection.y !== 1) {
                        if (!move.includes(2)) {
                            move.push(2)
                        }
                    } else if (event.key === "S" && lastDirection.y !== -1) {
                        if (!move.includes(3)) {
                            move.push(3)
                        }
                    }
                    
                })
            }

            function positionPointsDisplay() {
                let displayPoints = document.getElementById("pointDisplay")
                let rect = canvas.getBoundingClientRect()
                displayPoints.style.left = `${rect.left + rect.width / 2}px`
                displayPoints.style.top = `${rect.top - 40}px`
                displayPoints.style.transform = 'translateX(-50%)'
            }
            window.addEventListener("resize", positionPointsDisplay)
            function setPoint(value) {
                pointElement.innerText = value.toString();
                pointElementR.innerText = value.toString()
            }
            
            function restartGame() {
                
                let canvasx = canvas.width
                let canvasy = canvas.height
                let cx = canvasx /= squareSize.x
                let cy = canvasy /= squareSize.y
                let cx2 = cx/2
                let cy2 = cy/2
                food = {x: 2, y: 4}
                points = 0
                snake = 
                    [{x: cx2, y:cy2},
                    {x: cx2, y:cy2 + 1},
                    {x: cx2, y:cy2 + 2}]
                speed = {x: 0, y: -1}
                lastDirection = {x: 0, y: -1};
                move =
                    [
                    ]
                isAlive = true
                isFirstRun = false
                restartGameButton.innerText  = "Restart Game"
                menu.hidden = true
                restartGameMenu.hidden = true
                setPoint(points)
                resizeGame()
                startEngine()
            }
            
            function resizeGame(){
                if(isAlive === false) {

                    //console.log(document.getElementById("size"))
                    let size = parseInt(document.getElementById("size").value) * 10
                    canvas.width = squareSize.x * size
                    canvas.height = squareSize.y * size
                    canvasCenter()
                }

                positionPointsDisplay()
            }
            function setSpeed(){
                let gameSpeedElement = parseInt(document.getElementById("speed").value)
                gameSpeed = gameSpeedElement
                frameRate = 1000 / gameSpeed;

                then = performance.now();
                
                console.log(gameSpeed)
                console.log(frameRate)
            }
            function randomIntFromInterval(min, max) { // min and max included 
                return Math.floor(Math.random() * (max - min + 1) + min);
            }
            function playerDied() {
                openRestartGameMenu()
                //death logic
                isAlive = false
                console.log(isAlive)
                snake.splice(0, snake.length)
                snake.push(
                    {x: 10, y: 10},
                    {x: 10, y: 11},
                    {x: 10, y: 12}
                )
                move.splice(0, move.length)
                speed.x = 0;
                speed.y = 0;
                
            }
            function movementChecker(){
                check(0, 1)
                check(1, 0)
                check(2, 3)
                check(3, 2)
                
                check2(0, 1)
                check2(1, 0)
                check2(2, 3)
                check2(3, 2)
                
                check3(0, 1)
                check3(1, 0)
                check3(2, 3)
                check3(3, 2)

                
                
                if(move.length >= 3){
                    move.pop()
                }
            }

            function check(moveNumber, moveNumber2) {
                if (move[0] === moveNumber && move[1] === moveNumber2){
                    move[1] = null
                }
            }
            function check2(moveNumber, moveNumber2) {
                if (move[1] === moveNumber && move[2] === moveNumber2){
                    move[2] = null
                }
            }
            function check3(moveNumber, moveNumber2) {
                if (move[2] === moveNumber && move[3] === moveNumber2){
                    move[3] = null
                }
            }
            
            function gameLogic() {
                movementChecker()
                if (move[0] === 0) {
                    speed.x = 1;
                    speed.y = 0;
                    lastDirection.x = 1;
                    lastDirection.y = 0;
                }
                if (move[0] === 1) {
                    speed.x = -1;
                    speed.y = 0;
                    lastDirection.x = -1;
                    lastDirection.y = 0;
                }
                if (move[0] === 2) {
                    speed.x = 0;
                    speed.y = -1;
                    lastDirection.x = 0;
                    lastDirection.y = -1;
                }
                if (move[0] === 3) {
                    speed.x = 0;
                    speed.y = 1;
                    lastDirection.x = 0;
                    lastDirection.y = 1;
                }
                keydown()
                move.shift()
                
                let nextPos = {

                    x: snake[0].x + speed.x,
                    y: snake[0].y + speed.y


                }

                let segment = snake.slice(1).some(segment => segment.x === nextPos.x && segment.y === nextPos.y);

                let canvasx = canvas.width
                let canvasy = canvas.height
                let cx = canvasx /= squareSize.x
                let cy = canvasy /= squareSize.y
                if (segment || nextPos.x >= cx || nextPos.x < 0 || nextPos.y >= cy || nextPos.y < 0) {
                    playerDied();
                }
                function foodHandeler(food, otherFood){

                    if (food.x === nextPos.x && food.y === nextPos.y) {
                        snake.unshift(nextPos);
                        points += 1
                        setPoint(points)

                        food.x = randomIntFromInterval(0, canvas.width / squareSize.x)
                        food.y = randomIntFromInterval(0, canvas.height / squareSize.y)
                        do {
                            food.x = randomIntFromInterval(0, cx - 1)
                            food.y = randomIntFromInterval(0, cy - 1)
                        } while (
                            snake.some(segment => segment.x === food.x && segment.y === food.y) ||
                            (otherFood && otherFood.some(other => other.x === food.x && other.y === food.y))
                            )
                        return true
                    }else {
                        return false
                    }
                }

                
                let foods = [food, food1, food2, food3];
                let numberOfApples = parseInt(document.getElementById("Number of apples").value)
                let ate = foodHandeler(food)
                for (let i = 0; i < numberOfApples; i++) {
                    let otherFood = foods.slice(0, i).concat(foods.slice(i + 1))
                    
                    ate ||= foodHandeler(foods[i], otherFood);
                    
                }
                
                if (!ate){
                    snake.unshift(nextPos)
                    snake.pop()
                }
            }

            function logic() {
                if (isAlive) {
                    gameLogic()
                } else {
                }
            }
                

            function draw() {
                if (isAlive) {

                    ctx.clearRect(0, 0, canvas.width, canvas.height)
                    ctx.fillStyle = "blue"
                    snake.forEach((part) => {
                        ctx.fillRect(
                            part.x * squareSize.x,
                            part.y * squareSize.y,
                            squareSize.x,
                            squareSize.y)
                    });
                    for (let i = 0; i < snake.length; i++) {

                    }
                    if (speed.y === 1 || speed.x === 1 || speed.x === -1) {
                        ctx.fillStyle = "black"
                        ctx.fillRect(
                            snake[0].x * squareSize.x + 0.1 * squareSize.x,
                            snake[0].y * squareSize.y + 0.2 * squareSize.y,
                            squareSize.x / 5,
                            squareSize.y / 5
                        )
                        ctx.fillRect(
                            snake[0].x * squareSize.x + 0.7 * squareSize.x,
                            snake[0].y * squareSize.y + 0.2 * squareSize.y,
                            squareSize.x / 5,
                            squareSize.y / 5
                        )
                        ctx.fillStyle = "red"
                        ctx.fillRect(
                            snake[0].x * squareSize.x + 0.25 * squareSize.x,
                            snake[0].y * squareSize.y + 0.6 * squareSize.y,
                            squareSize.x / 2,
                            squareSize.y / 5
                        )
                    } else {
                        ctx.fillStyle = "red"
                        ctx.fillRect(
                            snake[0].x * squareSize.x + 0.25 * squareSize.x,
                            snake[0].y * squareSize.y + 0.1 * squareSize.y,
                            squareSize.x / 2,
                            squareSize.y / 5
                        )
                        ctx.fillStyle = "black"
                        ctx.fillRect(
                            snake[0].x * squareSize.x + 0.1 * squareSize.x,
                            snake[0].y * squareSize.y + 0.4 * squareSize.y,
                            squareSize.x / 5,
                            squareSize.y / 5
                        )
                        ctx.fillRect(
                            snake[0].x * squareSize.x + 0.7 * squareSize.x,
                            snake[0].y * squareSize.y + 0.4 * squareSize.y,
                            squareSize.x / 5,
                            squareSize.y / 5
                        )
                    }
                    if (speed.y === -1) {
                        ctx.fillStyle = "black"
                        ctx.fillRect(
                            snake[0].x * squareSize.x,
                            snake[0].y * squareSize.y,
                            squareSize.x,
                            squareSize.y / 30
                        )
                    } else if (speed.y === 1) {
                        ctx.fillStyle = "black"
                        ctx.fillRect(
                            snake[0].x * squareSize.x,
                            snake[0].y * squareSize.y + squareSize.y,
                            squareSize.x,
                            squareSize.y / 20
                        )
                    }
                    if (snake[snake.length - 1].y - 1 === snake[snake.length - 2].y) {
                        ctx.fillStyle = "black"
                        ctx.fillRect(
                            snake[snake.length - 1].x * squareSize.x,
                            snake[snake.length - 1].y * squareSize.y + squareSize.y,
                            squareSize.x,
                            squareSize.y / 20
                        )
                    }

                    if (snake[snake.length - 1].y + 1 === snake[snake.length - 2].y) {
                        ctx.fillStyle = "black"
                        ctx.fillRect(
                            snake[snake.length - 1].x * squareSize.x,
                            snake[snake.length - 1].y * squareSize.y,
                            squareSize.x,
                            squareSize.y / 20
                        )
                    }
                    if (speed.x === 1) {
                        ctx.fillStyle = "black"
                        ctx.fillRect(
                            snake[0].x * squareSize.x + squareSize.x,
                            snake[0].y * squareSize.y,
                            squareSize.x / 20,
                            squareSize.y
                        )
                    }
                    if (speed.x === -1) {
                        ctx.fillStyle = "black"
                        ctx.fillRect(
                            snake[0].x * squareSize.x,
                            snake[0].y * squareSize.y,
                            squareSize.x / 20,
                            squareSize.y
                        )
                    }
                    ctx.fillStyle = "black"

                    if (snake[snake.length - 1].x - 1 === snake[snake.length - 2].x) {
                        ctx.fillRect(
                            snake[snake.length - 1].x * squareSize.x + squareSize.x,
                            snake[snake.length - 1].y * squareSize.y,
                            squareSize.x / 20,
                            squareSize.y
                        )
                    }
                    if (snake[snake.length - 1].x + 1 === snake[snake.length - 2].x) {
                        ctx.fillRect(
                            snake[snake.length - 1].x * squareSize.x,
                            snake[snake.length - 1].y * squareSize.y,
                            squareSize.x / 20,
                            squareSize.y
                        )
                    }


                    ////ctx.createPattern()

                    let numberOfApples = document.getElementById("Number of apples").value
                    if (numberOfApples === "1") {
                        drawApples(food)
                    } else if (numberOfApples === "2") {
                        drawApples(food)
                        drawApples(food1)
                    } else if (numberOfApples === "3") {
                        drawApples(food)
                        drawApples(food1)
                        drawApples(food2)
                    } else if (numberOfApples === "4") {
                        drawApples(food)
                        drawApples(food1)
                        drawApples(food2)
                        drawApples(food3)
                    }

                    function drawApples(food) {
                        ctx.fillStyle = "red"
                        ctx.fillRect(
                            food.x * squareSize.x,
                            food.y * squareSize.y,
                            squareSize.x,
                            squareSize.y
                        );
                    }

                }
            }
            
            
            
            function drawBackground(){
                var backgroundEasy = new Image()
                backgroundEasy.src="./img/snakeBackgroundEasy.png"
                backgroundEasy.onload = function (){
                    ctx.drawImage(backgroundEasy, 0, 0)
                }
            }
            
            
            function engine() {
                logic();
                draw();
                
            }
            
            function startEngine() {
                function animate(now) {
                    requestAnimationFrame(animate);

                    const elapsed = now - then;
                    if (elapsed > frameRate) {
                        then = now - (elapsed % frameRate); // för exakt timing
                        engine();
                    }
                }

                requestAnimationFrame(animate);
                //let stop = setInterval(requestAnimationFrame, frameRate, engine)
            }
        </script>

    </body>
</html>
